<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宠医小兽 - 宠物医疗AI助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(145deg, #E8F4FF 0%, #F5F9FF 100%);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            background: linear-gradient(180deg, #EBF5FF 0%, #F7FAFF 100%);
            min-height: 100vh;
            position: relative;
            padding-bottom: 70px; /* 为底部搜索栏留出空间 */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }
        
        .header {
            padding: 20px;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .back-button {
            position: absolute;
            left: 20px;
            color: #4B7BF5;
            font-size: 24px;
            text-decoration: none;
            display: none;
        }
        
        .home-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #4B7BF5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            border-radius: 50%;
            background-color: #4B7BF5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }
        
        .header-text {
            flex: 1;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: bold;
            color: #000;
        }
        
        .header-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        .welcome-box {
            background-color: white;
            margin: 0 15px 20px;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(75, 123, 245, 0.08);
            transition: all 0.3s ease;
        }
        
        .welcome-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(75, 123, 245, 0.12);
        }
        
        .section-title {
            padding: 0 20px 10px;
            font-size: 16px;
            font-weight: bold;
            color: #4B7BF5;
        }
        
        .question-list {
            margin: 0 15px;
        }
        
        .question-item {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(75, 123, 245, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .question-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(75, 123, 245, 0.15);
        }
        
        .question-item:active {
            background-color: #F5F8FF;
        }
        
        .question-text {
            flex: 1;
            font-size: 15px;
        }
        
        .view-count {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .ask-button {
            background-color: #4B7BF5;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            border: none;
        }
        
        .hot-topics {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .topic-item {
            background-color: white;
            width: 23%;
            padding: 15px 5px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(75, 123, 245, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .topic-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(75, 123, 245, 0.12);
        }
        
        .topic-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #F0F6FF;
            border-radius: 50%;
        }
        
        .topic-icon img {
            width: 24px;
            height: 24px;
        }
        
        .topic-title {
            font-size: 13px;
            font-weight: bold;
        }
        
        .topic-subtitle {
            font-size: 11px;
            color: #999;
        }
        
        .search-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            max-width: 480px;
            margin: 0 auto;
        }
        
        .search-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background-color: #F5F8FF;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(75, 123, 245, 0.2);
            outline: none;
        }
        
        .search-mic {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }
        
        .search-send {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            cursor: pointer;
            opacity: 0.6;
        }
        
        .search-send.active {
            opacity: 1;
        }
        
        .disclaimer {
            text-align: center;
            padding: 15px;
            font-size: 12px;
            color: #999;
        }
        
        /* 聊天页面样式 */
        .chat-container {
            padding: 15px;
            display: none;
            position: relative;
            background: linear-gradient(145deg, #EBF5FF 0%, #F0F8FF 50%, #E5F0FF 100%);
            min-height: calc(100vh - 60px);
        }
        
        /* 添加聊天页面返回按钮样式 */
        .chat-back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4B7BF5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            /* 增加触摸区域 */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 添加激活状态效果 */
        .chat-back-button:active {
            transform: scale(0.95);
            background-color: #3A6AE4;
        }
        
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-ai {
            display: flex;
        }
        
        .message-user {
            display: flex;
            justify-content: flex-end;
        }
        
        .avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #4B7BF5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .avatar img {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-left: 8px;
            background-color: #E6EFFF;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-avatar img {
            width: 65%;
            height: 65%;
            object-fit: contain;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 15px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .ai-content {
            background: linear-gradient(120deg, #FFFFFF 0%, #F5F8FF 100%);
            border-radius: 0 18px 18px 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            line-height: 1.6;
        }
        
        .user-content {
            background: linear-gradient(120deg, #4B7BF5 0%, #3A6AE4 100%);
            color: white;
            border-radius: 18px 0 18px 18px;
        }
        
        .typing-indicator {
            display: flex;
            padding: 12px 15px;
            background-color: white;
            border-radius: 18px;
            width: fit-content;
            margin-top: 10px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #999;
            border-radius: 50%;
            animation: typingAnimation 1.5s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 1s;
        }
        
        @keyframes typingAnimation {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        .related-questions {
            margin-top: 20px;
        }
        
        .related-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .related-item {
            background-color: #F5F8FF;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .highlight {
            color: #4B7BF5;
            font-weight: bold;
            position: relative;
            padding: 0 2px;
            z-index: 1;
            display: inline-block;
        }
        
        .highlight:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background-color: rgba(75, 123, 245, 0.1);
            z-index: -1;
            border-radius: 3px;
        }
        
        @media (max-width: 375px) {
            .topic-item {
                padding: 10px 5px;
            }
            
            .topic-icon {
                width: 32px;
                height: 32px;
            }
            
            .topic-title {
                font-size: 12px;
            }
            
            .question-text {
                font-size: 14px;
            }
        }
        
        @media (max-width: 320px) {
            .hot-topics {
                flex-wrap: wrap;
                justify-content: space-around;
            }
            
            .topic-item {
                width: 48%;
                margin-bottom: 10px;
            }
            
            .question-text {
                font-size: 13px;
            }
            
            .view-count {
                font-size: 10px;
            }
        }
        
        /* 页面过渡动画 */
        #home-page, #chat-page {
            transition: all 0.3s ease-in-out;
        }
        
        /* 聊天气泡显示动画优化 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .loading-circle {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: #4B7BF5;
            border-radius: 50%;
            animation: loading 1.5s infinite ease-in-out;
        }
        
        .loading-circle:nth-child(1) {
            animation-delay: 0s;
        }
        
        .loading-circle:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .loading-circle:nth-child(3) {
            animation-delay: 1s;
        }
        
        @keyframes loading {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .data-pill {
            display: inline-block;
            background-color: rgba(75, 123, 245, 0.1);
            color: #4B7BF5;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 0 2px;
        }
        
        /* 添加以下样式到CSS部分 */
        
        /* 图表降级样式 */
        .chart-fallback {
            padding: 15px;
            background-color: white;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        .fallback-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #4B7BF5;
        }
        
        .fallback-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .fallback-label {
            width: 80px;
            font-size: 14px;
        }
        
        .fallback-bar {
            height: 24px;
            background: linear-gradient(90deg, #4B7BF5 0%, #3A6AE4 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 8px;
            border-radius: 4px;
            font-size: 12px;
            transition: width 0.5s ease;
        }
        
        /* 主题切换器 */
        .theme-switcher {
            position: absolute;
            right: 20px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(75, 123, 245, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* 兼容性修复 */
        @supports not (animation-name: fadeIn) {
            .message {
                opacity: 1;
                transform: none;
            }
        }
        
        /* 确保动画不会影响可访问性 */
        @media (prefers-reduced-motion: reduce) {
            .message, .typing-dot, .loading-circle {
                animation: none;
            }
            
            .question-item:hover, .topic-item:hover, .welcome-box:hover {
                transform: none;
            }
        }
        
        /* 改进聊天气泡文本溢出问题 */
        .message-content {
            max-width: 70%;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* 添加文本选择颜色 */
        ::selection {
            background: rgba(75, 123, 245, 0.2);
        }
        
        /* 添加结构化样式 */
        .ai-content {
            line-height: 1.6;
        }
        
        .ai-subtitle {
            color: #4B7BF5;
            font-size: 16px;
            margin: 12px 0 6px 0;
            font-weight: bold;
        }
        
        .list-item {
            margin: 8px 0;
            position: relative;
            padding-left: 25px;
            display: block;
            clear: both;
            overflow: visible;
        }
        
        .list-number {
            position: absolute;
            left: 0;
        }
        
        .warning-box {
            background-color: rgba(255, 190, 0, 0.1);
            border-left: 3px solid #FFB300;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .tip-box {
            background-color: rgba(75, 123, 245, 0.1);
            border-left: 3px solid #4B7BF5;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        /* 修复文本重叠问题 */
        .ai-content p, .ai-content div, .ai-content span {
            overflow: visible;
            word-wrap: break-word;
            word-break: break-all;
        }
        
        /* 确保聊天页面样式，修复渐变背景效果 */
        #chat-page {
            background: linear-gradient(145deg, #E8F4FF 0%, #EBF5FF 50%, #E5F0FF 100%) !important;
            min-height: 100vh !important;
        }
        
        /* 增强返回按钮的可点击性 */
        .chat-back-button {
            z-index: 9999 !important;
            cursor: pointer !important;
            background-color: #4B7BF5 !important;
            color: white !important;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3) !important;
        }
        
        /* 增强热门话题的可点击性 */
        .topic-item {
            cursor: pointer !important;
            transition: transform 0.2s ease-in-out !important;
        }
        
        .topic-item:active {
            transform: scale(0.95) !important;
            background-color: #F5F8FF !important;
        }
        
        /* 修改"大家都在问"部分的样式 */
        .popular-question-item {
            background-color: white;
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .question-text {
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .question-stats {
            font-size: 12px;
            color: #999;
        }
        
        .ask-btn {
            background-color: #4B7BF5;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Markdown样式 */
        .ai-content h1, .ai-content h2, .ai-content h3, .ai-content h4 {
            color: #4B7BF5;
            margin: 15px 0 8px 0;
        }
        
        .ai-content h1 {
            font-size: 20px;
        }
        
        .ai-content h2 {
            font-size: 18px;
        }
        
        .ai-content h3 {
            font-size: 16px;
        }
        
        .ai-content h4 {
            font-size: 15px;
        }
        
        .ai-content strong {
            color: #4B7BF5;
            font-weight: bold;
        }
        
        .ai-content em {
            font-style: italic;
        }
        
        .ai-content code {
            background-color: #f0f2f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .ai-content ul, .ai-content ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .ai-content li {
            margin-bottom: 5px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- 首页内容 -->
        <div id="home-page">
            <div class="header">
                <div class="logo">
                    <img src="https://cdn-icons-png.flaticon.com/512/2138/2138508.png" alt="宠医小兽">
                </div>
                <div class="header-text">
                    <div class="header-title">宠医小兽</div>
                    <div class="header-subtitle">您的智能宠物医疗助理</div>
                </div>
            </div>
            
            <div class="welcome-box">
                我是您的智能宠物医疗助理小兽～随时为您和爱宠提供健康指导！
            </div>
            
            <div class="section-title">大家都在问</div>
            
            <div class="question-list">
                <div class="question-item" onclick="showChat('我家宠物需要去哪级医院？')">
                    <div>
                        <div class="question-text">我家宠物需要去哪级医院？</div>
                        <div class="view-count">56780人看过 · 12045人问过</div>
                    </div>
                    <button class="ask-button">问问</button>
                </div>
                
                <div class="question-item" onclick="showChat('宠物疫苗接种的合理价格是多少？')">
                    <div>
                        <div class="question-text">宠物疫苗接种的合理价格是多少？</div>
                        <div class="view-count">42153人看过 · 8564人问过</div>
                    </div>
                    <button class="ask-button">问问</button>
                </div>
                
                <div class="question-item" onclick="showChat('如何判断一家宠物医院的服务质量？')">
                    <div>
                        <div class="question-text">如何判断一家宠物医院的服务质量？</div>
                        <div class="view-count">32891人看过 · 5642人问过</div>
                    </div>
                    <button class="ask-button">问问</button>
                </div>
                
                <div class="question-item" onclick="showChat('我的宠物不吃东西是什么原因？')">
                    <div>
                        <div class="question-text">我的宠物不吃东西是什么原因？</div>
                        <div class="view-count">28764人看过 · 6235人问过</div>
                    </div>
                    <button class="ask-button">问问</button>
                </div>
            </div>
            
            <div class="section-title">热门话题</div>
            
            <div class="hot-topics">
                <div class="topic-item">
                    <div class="topic-icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/2829/2829052.png" alt="医院选择">
                    </div>
                    <div class="topic-title">医院选择</div>
                    <div class="topic-subtitle">15个问题</div>
                </div>
                
                <div class="topic-item">
                    <div class="topic-icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/2492/2492458.png" alt="价格参考">
                    </div>
                    <div class="topic-title">价格参考</div>
                    <div class="topic-subtitle">18个问题</div>
                </div>
                
                <div class="topic-item">
                    <div class="topic-icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/2966/2966334.png" alt="症状自查">
                    </div>
                    <div class="topic-title">症状自查</div>
                    <div class="topic-subtitle">23个问题</div>
                </div>
                
                <div class="topic-item">
                    <div class="topic-icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/2787/2787276.png" alt="预防保健">
                    </div>
                    <div class="topic-title">预防保健</div>
                    <div class="topic-subtitle">19个问题</div>
                </div>
            </div>
            
            <div class="disclaimer">
                内容仅供参考，不构成诊疗建议
            </div>
        </div>
        
        <!-- 聊天页面 -->
        <div id="chat-page" class="chat-container">
            <!-- 加大返回按钮点击区域 -->
            <div class="chat-back-button" id="chat-back-button" style="padding: 10px;">←</div>
            
            <div id="chat-messages">
                <!-- 动态插入对话内容 -->
            </div>
            
            <div class="related-questions" id="related-questions">
                <div class="related-title">相关问题推荐</div>
                <!-- 动态插入相关问题 -->
            </div>
        </div>
        
        <div class="search-bar">
            <div class="search-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/3602/3602145.png" alt="搜索" width="24" height="24">
            </div>
            <input type="text" class="search-input" placeholder="宠物健康就问小兽">
            <div class="search-send">
                <img src="https://cdn-icons-png.flaticon.com/512/3682/3682321.png" alt="发送" width="24" height="24">
            </div>
        </div>
    </div>

    <script>
        // 预设问答内容
        const answers = {
            "我家宠物需要去哪级医院？": [
                "根据您的问题，我需要了解宠物的具体情况。不过，基于我们对武汉宠物医疗市场的研究，可以简单判断：",
                "- <span class='highlight'>社区医院(C)</span>适合：常规体检、疫苗接种、简单皮肤问题",
                "- <span class='highlight'>专科医院(P)</span>适合：皮肤、眼科、骨科等特定系统疾病",
                "- <span class='highlight'>中心医院(1)</span>适合：多系统疾病、危重症状、需要高级设备检查",
                "研究发现，<span class='highlight'>54.49%</span>的宠物主直接选择专科医院，导致医疗资源错配和等待时间延长。对于日常健康管理，建议优先选择社区医院，既方便又经济。",
                "您想了解更多选择建议吗？"
            ],
            "宠物疫苗接种的合理价格是多少？": [
                "根据我们的市场调研数据，武汉市宠物疫苗接种价格存在较大差异：",
                "- <span class='highlight'>社区医院</span>：单价约80-150元/针",
                "- <span class='highlight'>专科医院</span>：单价约120-200元/针",
                "- <span class='highlight'>中心医院</span>：单价约150-250元/针",
                "研究发现，<span class='highlight'>35%</span>的消费者（主要是年轻学生群体）对价格敏感度较高，而<span class='highlight'>45%</span>的中年高收入群体更注重服务质量。",
                "价格差异主要受疫苗品牌、进口/国产、医院级别等因素影响。建议您在选择时，综合考虑医院资质、服务体验和价格因素。",
                "您是否需要推荐性价比较高的宠物医院？"
            ],
            "如何判断一家宠物医院的服务质量？": [
                "基于我们的SERVQUAL六维度服务质量评估模型，您可以从以下几个方面判断：",
                "1. <span class='highlight'>有形性</span>：医院环境、设备是否现代化（社区医院通常为-1.09，专科医院为0.87）",
                "2. <span class='highlight'>响应性</span>：等待时间、紧急情况处理能力（中心医院表现最佳1.1）",
                "3. <span class='highlight'>保证性</span>：医生资质、技术水平（中心医院优势明显0.95）",
                "4. <span class='highlight'>移情性</span>：对宠物和主人的关怀程度（社区医院表现较好0.6）",
                "5. <span class='highlight'>经济性</span>：价格透明度、性价比（三级医院普遍为负值<-0.6）",
                "研究发现，不同消费者群体关注点不同：年轻学生群体更注重价格，中年高收入群体更看重专业性，年长群体则更重视服务态度。",
                "您属于哪种类型的宠物主呢？我可以提供更针对性的建议。"
            ],
            "我的宠物不吃东西是什么原因？": [
                "宠物不吃东西可能有多种原因，根据我们的调研数据，主要包括：",
                "1. <span class='highlight'>健康问题</span>：牙齿疾病、消化系统问题、疾病导致食欲下降",
                "2. <span class='highlight'>环境变化</span>：搬家、新家庭成员、生活环境改变",
                "3. <span class='highlight'>食物因素</span>：食物变质、口味改变、食物不适合",
                "4. <span class='highlight'>情绪问题</span>：压力、焦虑、抑郁等",
                "我们的研究发现，<span class='highlight'>73%</span>的宠物食欲问题在社区医院就能得到有效解决，但<span class='highlight'>65.3%</span>的宠物主会直接去专科医院，导致医疗资源浪费。",
                "建议您先观察：如果宠物连续24小时不进食，或伴有其他症状（如呕吐、腹泻、精神萎靡），应及时就医。简单食欲不振可先去社区医院检查。",
                "您需要进一步了解如何选择合适的医院吗？"
            ]
        };
        
        // 相关问题推荐
        const relatedQuestions = {
            "我家宠物需要去哪级医院？": [
                "社区医院与专科医院有什么区别？",
                "如何判断宠物疾病的严重程度？",
                "武汉市优质宠物医院推荐"
            ],
            "宠物疫苗接种的合理价格是多少？": [
                "宠物疫苗接种需要注意什么？",
                "不同品牌疫苗的差异是什么？",
                "宠物疫苗接种后的常见反应"
            ],
            "如何判断一家宠物医院的服务质量？": [
                "选择宠物医院的关键指标是什么？",
                "宠物医院的价格透明度如何查询？",
                "不同级别宠物医院的专业水平差异"
            ],
            "我的宠物不吃东西是什么原因？": [
                "宠物食欲不振的家庭护理方法",
                "什么情况下宠物必须立即就医？",
                "如何判断宠物是否脱水？"
            ]
        };
        
        // 输入验证与防抖优化
        let typingTimer;
        const doneTypingInterval = 500; // 毫秒

        document.querySelector('.search-input').addEventListener('input', function() {
            clearTimeout(typingTimer);
            
            if (this.value) {
                document.querySelector('.search-icon img').src = "https://cdn-icons-png.flaticon.com/512/3917/3917754.png"; // 切换到清除图标
                document.querySelector('.search-send').classList.add('active'); // 激活发送按钮
            } else {
                document.querySelector('.search-icon img').src = "https://cdn-icons-png.flaticon.com/512/3602/3602145.png"; // 恢复搜索图标
                document.querySelector('.search-send').classList.remove('active'); // 取消激活发送按钮
            }
            
            typingTimer = setTimeout(() => {
                // 可以在这里添加输入建议逻辑
            }, doneTypingInterval);
        });

        // 添加发送按钮点击事件
        document.querySelector('.search-send').addEventListener('click', function() {
            const input = document.querySelector('.search-input');
            const question = input.value.trim();
            if(question) {
                showChat(question);
                input.value = '';
                this.classList.remove('active'); // 发送后取消激活状态
            }
        });

        // 清空输入框功能
        document.querySelector('.search-icon').addEventListener('click', function() {
            const input = document.querySelector('.search-input');
            if (input.value.trim()) {
                input.value = '';
                document.querySelector('.search-icon img').src = "https://cdn-icons-png.flaticon.com/512/3602/3602145.png";
            }
        });

        // 修改返回按钮的onclick事件处理程序
        document.getElementById('home-button').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('chat-page').style.display = 'none';
            document.querySelector('.back-button').style.display = 'none';
            
            // 更新URL
            history.pushState({page: 'home'}, '', window.location.pathname);
        });

        // 修改调用AI API的函数，正确适配deepseek API
        async function callAIAPI(question) {
            try {
                // 显示发送中状态
                const typingDiv = document.createElement('div');
                typingDiv.classList.add('message', 'message-ai');
                typingDiv.innerHTML = `
                    <div class="avatar">
                        <img src="https://cdn-icons-png.flaticon.com/512/2138/2138508.png" alt="宠医小兽">
                    </div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                document.getElementById('chat-messages').appendChild(typingDiv);

                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-a37818a554034b16ba4a30d7e32b3fc7'
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "system",
                                content: "你是一个名为'宠医小兽'的宠物医疗AI助手，专注于回答宠物健康、医疗、行为等问题。回答要专业、友好且易于理解。请使用Markdown格式来回答问题，特别是在列表、标题和重点内容上，以提高可读性。将重要知识点或关键词用**粗体**标记，适当使用markdown标题语法（如# 标题）来分隔内容，使用有序或无序列表来组织信息。"
                            },
                            {
                                role: "user",
                                content: question
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1500
                    })
                });

                // 移除typing指示器
                document.getElementById('chat-messages').removeChild(typingDiv);

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                let content = data.choices[0].message.content;
                
                // 转换Markdown为HTML
                content = parseMdToHtml(content);
                
                return content;
            } catch (error) {
                console.error("API调用出错:", error);
                return `很抱歉，我暂时无法回答您的问题。请稍后再试。<br>错误信息: ${error.message}`;
            }
        }

        // 添加Markdown解析函数
        function parseMdToHtml(text) {
            // 基本Markdown解析
            let html = text
                // 标题
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                
                // 粗体和斜体
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                
                // 列表
                .replace(/^\d+\. (.*$)/gm, '<li class="ordered-list-item">$1</li>')
                .replace(/^- (.*$)/gm, '<li class="unordered-list-item">$1</li>')
                
                // 换行和段落
                .replace(/\n\n/g, '<br><br>')
                
                // 高亮
                .replace(/`(.*?)`/g, '<code>$1</code>');
            
            // 包装列表项
            html = html
                .replace(/<li class="ordered-list-item">(.*?)<\/li>/g, function(match) {
                    return '<ol>' + match + '</ol>';
                })
                .replace(/<\/ol><ol>/g, '')
                .replace(/<li class="unordered-list-item">(.*?)<\/li>/g, function(match) {
                    return '<ul>' + match + '</ul>';
                })
                .replace(/<\/ul><ul>/g, '');
            
            return html;
        }

        // 提取问题关键词函数
        function extractKeywords(question) {
            // 简单的关键词提取逻辑
            const stopWords = ["的", "是", "在", "了", "和", "与", "或", "什么", "为什么", "如何", "怎么"];
            return question.split(/\s+|[,，.。!！?？、:：]/)
                .filter(word => word.length > 1 && !stopWords.includes(word));
        }

        // 修改showChat函数，保留历史聊天记录
        function showChat(question) {
            // 显示聊天页面，隐藏首页
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-page').style.display = 'block';
            
            // 确保返回按钮可见并正确添加
            const backButton = document.querySelector('.back-button');
            if (!backButton) {
                const newBackButton = document.createElement('a');
                newBackButton.classList.add('back-button');
                newBackButton.innerHTML = '←';
                newBackButton.href = '#';
                newBackButton.style.display = 'block'; // 确保显示
                newBackButton.onclick = function(e) {
                    e.preventDefault();
                    document.getElementById('home-page').style.display = 'block';
                    document.getElementById('chat-page').style.display = 'none';
                    this.style.display = 'none';
                    history.pushState({page: 'home'}, '', window.location.pathname);
                };
                document.querySelector('.header').appendChild(newBackButton);
            } else {
                backButton.style.display = 'block';
            }
            
            // 添加历史状态
            history.pushState({page: 'chat', question: question}, '', '?q=' + encodeURIComponent(question));
            
            // 不再清空聊天记录，保留历史会话
            // document.getElementById('chat-messages').innerHTML = '';
            
            // 添加用户问题
            addUserMessage(question);
            
            // 检查是否是预设问题
            if (answers[question]) {
                // 预设问题处理
                setTimeout(() => {
                    // 显示正在输入
                    const typingDiv = document.createElement('div');
                    typingDiv.classList.add('message', 'message-ai');
                    typingDiv.innerHTML = `
                        <div class="avatar">
                            <img src="https://cdn-icons-png.flaticon.com/512/2138/2138508.png" alt="宠医小兽">
                        </div>
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    `;
                    document.getElementById('chat-messages').appendChild(typingDiv);
                    
                    setTimeout(() => {
                        // 删除typing指示器
                        document.getElementById('chat-messages').removeChild(typingDiv);
                        
                        // 一次性展示完整回答（合并所有回答段落）
                        const answer = answers[question];
                        const completeAnswer = answer.join("<br><br>");
                        addAIMessage(completeAnswer);
                        
                        // 回答后显示相关问题
                        addRelatedQuestions(question);
                        
                        // 滚动到底部
                        window.scrollTo(0, document.body.scrollHeight);
                    }, 1500);
                }, 500);
            } else {
                // 非预设问题，调用AI API
                (async () => {
                    const aiResponse = await callAIAPI(question);
                    addAIMessage(aiResponse);
                    
                    // 生成相关问题
                    const relatedQs = await generateRelatedQuestions(question, aiResponse);
                    // 保存到relatedQuestions对象
                    relatedQuestions[question] = relatedQs;
                    addRelatedQuestions(question);
                    
                    // 滚动到底部
                    window.scrollTo(0, document.body.scrollHeight);
                })();
            }
        }
        
        // 添加用户消息
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'message-user');
            messageDiv.innerHTML = `
                <div class="message-content user-content">${text}</div>
                <div class="user-avatar">
                    <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" alt="用户">
                </div>
            `;
            document.getElementById('chat-messages').appendChild(messageDiv);
        }
        
        // 添加AI消息
        function addAIMessage(text, speed = 30) {
            // 检测设备性能
            const isLowEndDevice = window.navigator.hardwareConcurrency < 4;
            const finalSpeed = isLowEndDevice ? 10 : speed; // 低端设备加快显示
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'message-ai');
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content', 'ai-content');
            
            messageDiv.innerHTML = `
                <div class="avatar">
                    <img src="https://cdn-icons-png.flaticon.com/512/2138/2138508.png" alt="宠医小兽">
                </div>
            `;
            messageDiv.appendChild(contentDiv);
            document.getElementById('chat-messages').appendChild(messageDiv);
            
            // 对于低端设备，可以一次性显示较短消息
            if (isLowEndDevice && text.length < 50) {
                contentDiv.innerHTML = text;
                return;
            }
            
            // 打字效果
            let html = '';
            let textOnly = '';
            let i = 0;
            
            const typeText = () => {
                // 将整段文本当作HTML解析
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                const textContent = tempDiv.textContent;
                
                // 分批处理，减少DOM操作
                let chunkSize = isLowEndDevice ? 5 : 1;
                
                if (i < textContent.length) {
                    textOnly += textContent.substr(i, chunkSize);
                    i += chunkSize;
                    
                    // 重新设置完整的HTML，但只显示部分文本
                    contentDiv.innerHTML = highlightText(text, textOnly);
                    
                    if (i < textContent.length) {
                        setTimeout(typeText, finalSpeed);
                    }
                    
                    // 滚动到底部
                    window.scrollTo(0, document.body.scrollHeight);
                }
            };
            
            // 辅助函数：保留HTML标签但只显示指定长度的文本
            function highlightText(html, visibleText) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                function processNode(node, currentLength) {
                    if (currentLength >= visibleText.length) {
                        return currentLength;
                    }
                    
                    if (node.nodeType === 3) { // 文本节点
                        const text = node.textContent;
                        const remaining = visibleText.length - currentLength;
                        
                        if (remaining >= text.length) {
                            currentLength += text.length;
                        } else {
                            node.textContent = text.substr(0, remaining);
                            currentLength += remaining;
                        }
                    } else if (node.nodeType === 1) { // 元素节点
                        const childNodes = Array.from(node.childNodes);
                        for (const child of childNodes) {
                            currentLength = processNode(child, currentLength);
                            if (currentLength >= visibleText.length) {
                                break;
                            }
                        }
                    }
                    return currentLength;
                }
                
                processNode(tempDiv, 0);
                return tempDiv.innerHTML;
            }
            
            // 简化处理：直接设置HTML内容
            contentDiv.innerHTML = text;
        }
        
        // 添加相关问题
        function addRelatedQuestions(question) {
            const relatedDiv = document.getElementById('related-questions');
            relatedDiv.innerHTML = '<div class="related-title">相关问题推荐</div>';
            
            const questions = relatedQuestions[question];
            questions.forEach(q => {
                const div = document.createElement('div');
                div.classList.add('related-item');
                div.textContent = q;
                div.onclick = function() {
                    showChat(q);
                };
                relatedDiv.appendChild(div);
            });
        }

        // 为搜索输入框添加回车发送功能
        document.querySelector('.search-input').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                const question = this.value.trim();
                if(question) {
                    showChat(question);
                    this.value = '';
                }
            }
        });

        // 为热门话题添加点击事件
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，绑定热门话题和返回按钮事件');
            
            // 热门话题点击事件
            const topicItems = document.querySelectorAll('.topic-item');
            const topicQuestions = [
                "我家宠物需要去哪级医院？", // 医院选择
                "宠物疫苗接种的合理价格是多少？", // 价格参考
                "我的宠物不吃东西是什么原因？", // 症状自查
                "宠物需要定期做哪些健康检查？" // 预防保健
            ];
            
            // 清除所有旧事件
            topicItems.forEach(item => {
                // 复制节点以移除旧事件监听器
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
            });
            
            // 重新绑定热门话题点击事件
            document.querySelectorAll('.topic-item').forEach((item, index) => {
                item.style.cursor = 'pointer';
                item.addEventListener('click', function() {
                    console.log('点击热门话题:', topicQuestions[index]);
                    showChat(topicQuestions[index]);
                });
            });
            
            // 聊天返回按钮事件
            const chatBackBtn = document.getElementById('chat-back-button');
            if(chatBackBtn) {
                chatBackBtn.style.cursor = 'pointer';
                chatBackBtn.addEventListener('click', function(e) {
                    console.log('点击返回按钮');
                    e.preventDefault();
                    document.getElementById('home-page').style.display = 'block';
                    document.getElementById('chat-page').style.display = 'none';
                    window.scrollTo(0, 0);
                });
                
                // 添加触摸事件支持
                chatBackBtn.addEventListener('touchstart', function(e) {
                    console.log('触摸返回按钮');
                    e.preventDefault();
                    document.getElementById('home-page').style.display = 'block';
                    document.getElementById('chat-page').style.display = 'none';
                    window.scrollTo(0, 0);
                });
            }
        });
        
        // 确保聊天页面样式，修复渐变背景效果
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                #chat-page {
                    background: linear-gradient(145deg, #E8F4FF 0%, #EBF5FF 50%, #E5F0FF 100%) !important;
                    min-height: 100vh !important;
                }
                
                /* 增强返回按钮的可点击性 */
                .chat-back-button {
                    z-index: 9999 !important;
                    cursor: pointer !important;
                    background-color: #4B7BF5 !important;
                    color: white !important;
                    -webkit-tap-highlight-color: transparent;
                    box-shadow: 0 3px 8px rgba(0,0,0,0.3) !important;
                }
                
                /* 增强热门话题的可点击性 */
                .topic-item {
                    cursor: pointer !important;
                    transition: transform 0.2s ease-in-out !important;
                }
                
                .topic-item:active {
                    transform: scale(0.95) !important;
                    background-color: #F5F8FF !important;
                }
            </style>
        `);
        
        // 重新定义返回按钮点击函数，确保能正常执行
        function handleBackReturn() {
            console.log('执行返回函数');
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('chat-page').style.display = 'none';
            window.scrollTo(0, 0);
        }
        
        // 确保DOM加载完成后重新绑定事件
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(function() {
                // 绑定返回按钮事件
                const chatBackBtn = document.getElementById('chat-back-button');
                if(chatBackBtn) {
                    console.log('立即绑定返回按钮事件');
                    // 移除旧事件
                    const newChatBackBtn = chatBackBtn.cloneNode(true);
                    chatBackBtn.parentNode.replaceChild(newChatBackBtn, chatBackBtn);
                    
                    // 添加新事件
                    newChatBackBtn.onclick = handleBackReturn;
                    newChatBackBtn.ontouchstart = handleBackReturn;
                }
                
                // 绑定热门话题点击事件
                document.querySelectorAll('.topic-item').forEach((item, index) => {
                    const topicQuestions = [
                        "我家宠物需要去哪级医院？",
                        "宠物疫苗接种的合理价格是多少？",
                        "我的宠物不吃东西是什么原因？",
                        "宠物需要定期做哪些健康检查？"
                    ];
                    
                    console.log('立即绑定热门话题:', index);
                    item.onclick = function() {
                        showChat(topicQuestions[index]);
                    };
                });
            }, 300);
        }

        // 为新添加的预设问题添加答案
        answers["宠物需要定期做哪些健康检查？"] = [
            "根据我们的研究数据，宠物的定期健康检查非常重要。以下是建议的检查项目：",
            "1. <span class='highlight'>基础体检</span>：包括体温、体重、心率等基础指标检查，建议每3-6个月一次",
            "2. <span class='highlight'>血液检查</span>：包括血常规和生化检查，可发现早期肝肾功能异常，建议每年1-2次",
            "3. <span class='highlight'>粪便检查</span>：检查肠道寄生虫情况，建议每6个月一次",
            "4. <span class='highlight'>心脏检查</span>：包括听诊和心电图，适合老年宠物或有心脏问题的宠物，建议每年一次",
            "5. <span class='highlight'>牙齿检查</span>：检查牙结石和牙周疾病，建议每年1-2次",
            "我们的调研显示，<span class='highlight'>78.5%</span>的宠物疾病可以通过定期检查提前发现，但只有<span class='highlight'>23.7%</span>的宠物主会定期带宠物体检。",
            "您的宠物上次体检是什么时候呢？"
        ];
        
        // 为新问题添加相关问题推荐
        relatedQuestions["宠物需要定期做哪些健康检查？"] = [
            "老年宠物需要做哪些特殊检查？",
            "宠物体检的合理价格是多少？",
            "如何选择靠谱的宠物医院做体检？"
        ];

        // 图片懒加载
        document.addEventListener("DOMContentLoaded", function() {
            const images = document.querySelectorAll('img');
            
            const lazyLoad = target => {
                const io = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            
                            if (src) {
                                img.setAttribute('src', src);
                                img.removeAttribute('data-src');
                            }
                            
                            observer.disconnect();
                        }
                    });
                });
                
                io.observe(target);
            };
            
            images.forEach(image => {
                if (image.getAttribute('src')) {
                    const dataSrc = image.getAttribute('src');
                    image.setAttribute('data-src', dataSrc);
                    image.setAttribute('src', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PC9zdmc+'); // 轻量级占位符
                    lazyLoad(image);
                }
            });
        });

        // 添加深色模式支持
        const html = document.documentElement;
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        // 添加主题切换功能
        function addThemeSwitcher() {
            const switcher = document.createElement('div');
            switcher.classList.add('theme-switcher');
            switcher.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/3073/3073665.png" alt="主题" width="18" height="18">`;
            document.querySelector('.header').appendChild(switcher);
            
            switcher.addEventListener('click', toggleTheme);
            
            // 应用初始主题
            if (localStorage.getItem('theme') === 'dark' || (prefersDarkMode && !localStorage.getItem('theme'))) {
                html.classList.add('dark-mode');
                applyDarkMode();
            }
        }

        function toggleTheme() {
            if (html.classList.contains('dark-mode')) {
                html.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                applyLightMode();
            } else {
                html.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                applyDarkMode();
            }
        }

        function applyDarkMode() {
            // 添加深色模式CSS
            const darkCSS = document.createElement('style');
            darkCSS.id = 'dark-mode-styles';
            darkCSS.innerHTML = `
                body { background: #121212; color: #e0e0e0; }
                .container { background: #1e1e1e; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); }
                .welcome-box, .question-item, .topic-item, .search-bar { background-color: #2d2d2d; color: #e0e0e0; }
                .topic-icon { background-color: #383838; }
                .header-title { color: #e0e0e0; }
                .header-subtitle, .view-count, .topic-subtitle { color: #aaa; }
                .search-input { background-color: #383838; color: #e0e0e0; }
                .ai-content { background: linear-gradient(120deg, #2d2d2d 0%, #252525 100%); color: #e0e0e0; }
                .related-item { background-color: #383838; color: #e0e0e0; }
            `;
            document.head.appendChild(darkCSS);
        }

        function applyLightMode() {
            const darkStyles = document.getElementById('dark-mode-styles');
            if (darkStyles) {
                darkStyles.remove();
            }
        }

        // 页面加载时检查URL参数
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const question = urlParams.get('q');
            
            if (question) {
                showChat(decodeURIComponent(question));
            }
            
            // 添加主题切换器
            addThemeSwitcher();

            // 检查浏览器兼容性
            const isModernBrowser = 'IntersectionObserver' in window && 'history' in window && 'pushState' in history;
            
            if (!isModernBrowser) {
                console.warn('您的浏览器可能不支持某些现代功能，体验可能受限');
                // 可以添加简单的提示
                const notice = document.createElement('div');
                notice.className = 'browser-notice';
                notice.textContent = '建议使用最新版Chrome、Firefox或Safari浏览器获得最佳体验';
                document.body.insertBefore(notice, document.body.firstChild);
            }
        });

        // 修改相关问题生成逻辑
        async function generateRelatedQuestions(question, aiResponse) {
            // 从预设问题列表中选择，若没有则动态生成
            if (relatedQuestions[question]) {
                return relatedQuestions[question];
            }
            
            try {
                // 提取问题和回答中的关键词
                const keywords = extractKeywords(question);
                const responseKeywords = extractKeywords(aiResponse);
                const allKeywords = [...new Set([...keywords, ...responseKeywords])];
                
                // 基于原问题和回答内容生成相关问题
                // 这里使用一个简化的逻辑，实际项目中可以再次调用AI API来生成相关问题
                const petType = question.match(/(猫|狗|兔子|仓鼠|宠物)/g) || ["宠物"];
                const problemType = question.match(/(掉毛|皮肤|食欲|疫苗|价格|医院|生病|症状|行为)/g) || [];
                
                // 生成3个相关问题
                const related = [];
                
                // 如果问题涉及特定宠物问题
                if (problemType.length > 0) {
                    related.push(`${petType[0]}${problemType[0]}问题的常见解决方法？`);
                    related.push(`${petType[0]}${problemType[0]}问题多久需要就医？`);
                }
                
                // 添加一些通用问题
                if (related.length < 3) {
                    related.push(`${petType[0]}日常护理的注意事项有哪些？`);
                    if (related.length < 3) {
                        related.push(`如何判断${petType[0]}健康状况是否良好？`);
                    }
                }
                
                return related;
            } catch (error) {
                console.error("生成相关问题失败:", error);
                // 返回默认相关问题
                return [
                    "宠物日常护理有哪些注意事项？",
                    "宠物常见疾病的早期症状有哪些？",
                    "如何为宠物选择合适的食物？"
                ];
            }
        }

        // 改进popstate事件处理
        window.addEventListener('popstate', function(event) {
            if (document.getElementById('chat-page').style.display === 'block') {
                document.getElementById('home-page').style.display = 'block';
                document.getElementById('chat-page').style.display = 'none';
                document.querySelector('.back-button').style.display = 'none';
            }
            
            // 如果有状态，处理状态跳转
            if (event.state && event.state.page === 'chat') {
                showChat(event.state.question);
            }
        });

        // 修复showDataChart函数，合并两个版本
        function showDataChart(question, containerId) {
            try {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                // 如果Chart.js不可用，使用降级展示
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js not available');
                }
                
                const canvas = document.createElement('canvas');
                canvas.id = 'dataChart';
                container.appendChild(canvas);
                
                let data, labels, title;
                
                switch(question) {
                    case "宠物疫苗接种的合理价格是多少？":
                        labels = ['社区医院', '专科医院', '中心医院'];
                        data = [115, 160, 200]; // 平均价格
                        title = '各级医院疫苗均价(元)';
                        break;
                    case "我家宠物需要去哪级医院？":
                        labels = ['社区医院', '专科医院', '中心医院'];
                        data = [25.5, 54.49, 20.01]; // 用户选择比例
                        title = '宠物主医院选择比例(%)';
                        break;
                    case "如何判断一家宠物医院的服务质量？":
                        labels = ['有形性', '响应性', '保证性', '移情性', '经济性'];
                        data = [-1.09, 1.1, 0.95, 0.6, -0.6]; // 评分数据
                        title = '医院服务质量评估指标';
                        break;
                    case "我的宠物不吃东西是什么原因？":
                        labels = ['健康问题', '环境变化', '食物因素', '情绪问题'];
                        data = [45, 25, 20, 10]; // 原因分布
                        title = '宠物不进食原因分布(%)';
                        break;
                    case "宠物需要定期做哪些健康检查？":
                        labels = ['基础体检', '血液检查', '粪便检查', '心脏检查', '牙齿检查'];
                        data = [85, 65, 45, 30, 50]; // 重要性评分
                        title = '宠物健康检查项目重要性(%)';
                        break;
                    default:
                        labels = ['未知数据'];
                        data = [0];
                        title = '暂无数据';
                }
                
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: data,
                            backgroundColor: [
                                'rgba(75, 123, 245, 0.7)',
                                'rgba(75, 123, 245, 0.9)',
                                'rgba(75, 123, 245, 0.5)',
                                'rgba(75, 123, 245, 0.6)',
                                'rgba(75, 123, 245, 0.4)'
                            ],
                            borderColor: [
                                'rgba(75, 123, 245, 1)',
                                'rgba(75, 123, 245, 1)',
                                'rgba(75, 123, 245, 1)',
                                'rgba(75, 123, 245, 1)',
                                'rgba(75, 123, 245, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.warn('Chart rendering failed, using fallback', error);
                
                // 降级到纯文本数据展示
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                const fallbackDiv = document.createElement('div');
                fallbackDiv.classList.add('chart-fallback');
                
                let data, labels, title;
                
                // 获取数据的逻辑与上面相同
                switch(question) {
                    case "宠物疫苗接种的合理价格是多少？":
                        labels = ['社区医院', '专科医院', '中心医院'];
                        data = [115, 160, 200]; // 平均价格
                        title = '各级医院疫苗均价(元)';
                        break;
                    case "我家宠物需要去哪级医院？":
                        labels = ['社区医院', '专科医院', '中心医院'];
                        data = [25.5, 54.49, 20.01]; // 用户选择比例
                        title = '宠物主医院选择比例(%)';
                        break;
                    case "宠物需要定期做哪些健康检查？":
                        labels = ['基础体检', '血液检查', '粪便检查', '心脏检查', '牙齿检查'];
                        data = [85, 65, 45, 30, 50]; // 重要性评分
                        title = '宠物健康检查项目重要性(%)';
                        break;
                    default:
                        labels = ['数据1', '数据2', '数据3'];
                        data = [30, 50, 20];
                        title = '数据统计';
                }
                
                //
                // 创建表格型展示
                fallbackDiv.innerHTML = `
                    <div class="fallback-title">${title}</div>
                    <div class="fallback-data">
                        ${labels.map((label, i) => `
                            <div class="fallback-item">
                                <div class="fallback-label">${label}</div>
                                <div class="fallback-bar" style="width: ${data[i]*100/Math.max(...data)}%">${data[i]}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(fallbackDiv);
            }
        }

        // 修改"大家都在问"部分的数据
        const popularQuestions = [
            {
                question: "我家宠物需要去哪级医院？",
                viewed: 5678,
                asked: 1204
            },
            {
                question: "宠物疫苗接种的合理价格是多少？",
                viewed: 4215,
                asked: 856
            },
            {
                question: "如何判断一家宠物医院的服务质量？",
                viewed: 3289,
                asked: 564
            },
            {
                question: "我的宠物不吃东西是什么原因？",
                viewed: 2876,
                asked: 623
            }
        ];

        // 添加显示"大家都在问"数据的函数
        function renderPopularQuestions() {
            const questionsContainer = document.querySelector('.popular-questions');
            if (!questionsContainer) return;
            
            // 清空现有内容
            questionsContainer.innerHTML = '';
            
            // 添加"大家都在问"标题
            const titleDiv = document.createElement('div');
            titleDiv.className = 'section-title';
            titleDiv.textContent = '大家都在问';
            questionsContainer.appendChild(titleDiv);
            
            // 添加问题列表
            popularQuestions.forEach(item => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'popular-question-item';
                
                questionDiv.innerHTML = `
                    <div class="question-content">
                        <div class="question-text">${item.question}</div>
                        <div class="question-stats">${item.viewed}人看过 · ${item.asked}人问过</div>
                    </div>
                    <button class="ask-btn">问问</button>
                `;
                
                // 添加点击事件
                questionDiv.querySelector('.ask-btn').addEventListener('click', function() {
                    showChat(item.question);
                });
                
                // 整个问题项也可点击
                questionDiv.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('ask-btn')) {
                        showChat(item.question);
                    }
                });
                
                questionsContainer.appendChild(questionDiv);
            });
        }

        // 在DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 渲染"大家都在问"部分
            renderPopularQuestions();
            
            // 其他初始化代码...
            console.log('DOM加载完成，绑定热门话题和返回按钮事件');
            
            // 热门话题点击事件
            const topicItems = document.querySelectorAll('.topic-item');
            const topicQuestions = [
                "我家宠物需要去哪级医院？", // 医院选择
                "宠物疫苗接种的合理价格是多少？", // 价格参考
                "我的宠物不吃东西是什么原因？", // 症状自查
                "宠物需要定期做哪些健康检查？" // 预防保健
            ];
            
            // ... 其他现有代码 ...
        });
    </script>
</body>
</html>
